<!doctype html>

<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Барабан — валюты и числа</title>
  <style>
    :root{--size:520px}
    body{font-family:Inter, Arial, sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#0b1220;color:#fff}
    .wrap{width:calc(var(--size) + 40px);text-align:center}
    canvas{width:var(--size);height:var(--size);display:block;margin:0 auto;border-radius:50%;background:transparent}
    .pointer{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:20px solid #ffd54a;margin:14px auto}
    .controls{display:flex;gap:10px;justify-content:center;margin-top:8px}
    button{background:#06b6d4;border:none;padding:10px 14px;border-radius:10px;color:#02111a;font-weight:700;cursor:pointer}
    .result{margin-top:12px;font-size:16px;min-height:24px}
    .muted{font-size:13px;opacity:0.8}
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="wheel"></canvas>
    <div class="pointer" aria-hidden></div>
    <div class="controls">
      <button id="spinBtn">Крутить</button>
      <button id="resetBtn">Сброс</button>
    </div>
    <div class="result" id="result">Готово — выберите "Крутить".</div>
    <div class="muted">Первый спин — валюты. После первого спина барабан автоматически переключится на числа 1–50.</div>
  </div>  <script>
    // Простая, рабочая версия барабана на canvas.
    // Ключевые улучшения:
    // - корректный расчёт выбранного сегмента
    // - правильный DPI-репорт для чёткого рендеринга
    // - плавная анимация и подсветка выбранного сегмента

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const spinBtn = document.getElementById('spinBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resultEl = document.getElementById('result');

    // Начальные валюты
    const initialSegments = [
      'Bitcoin (BTC)', 'Ethereum (ETH)', 'TON', 'USDT', 'USDC', 'Litecoin (LTC)', 'Dogecoin (DOGE)', 'Ripple (XRP)'
    ];

    let segments = initialSegments.slice();
    let isNumbersMode = false;

    // графика
    let dpr = Math.max(1, window.devicePixelRatio || 1);
    function resizeCanvas(){
      const size = Math.min(520, window.innerWidth - 40);
      canvas.style.width = size + 'px';
      canvas.style.height = size + 'px';
      const w = Math.floor(size * dpr);
      const h = Math.floor(size * dpr);
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
      }
    }
    resizeCanvas();
    window.addEventListener('resize', ()=>{ dpr = Math.max(1, window.devicePixelRatio || 1); resizeCanvas(); draw(); });

    function cx(){ return canvas.width/2; }
    function cy(){ return canvas.height/2; }
    function radius(){ return Math.min(canvas.width, canvas.height)/2 - 20*dpr; }

    // вращение в радианах
    let rotation = 0; // текущая абсолютная ротация
    let spinning = false;

    function draw(highlightIndex = -1){
      const Cx = cx();
      const Cy = cy();
      const R = radius();
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const n = segments.length;
      const slice = (Math.PI*2)/n;

      ctx.save();
      ctx.translate(Cx, Cy);
      ctx.rotate(rotation);

      // рисуем сегменты — начинаем от -PI/2 чтобы 0-й сегмент был вверху при rotation = 0
      for (let i=0;i<n;i++){
        const start = -Math.PI/2 + i*slice;
        const end = start + slice;

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,R,start,end);
        ctx.closePath();

        // заливка
        const hue = Math.round((i/n)*360);
        ctx.fillStyle = `hsl(${hue} 60% 45%)`;
        ctx.fill();

        // обводка или подсветка
        if (i === highlightIndex){
          ctx.lineWidth = 8*dpr;
          ctx.strokeStyle = 'rgba(255,255,200,0.95)';
        } else {
          ctx.lineWidth = 1*dpr;
          ctx.strokeStyle = 'rgba(0,0,0,0.2)';
        }
        ctx.stroke();

        // текст
        ctx.save();
        const mid = start + slice/2;
        ctx.rotate(mid);
        ctx.translate(R*0.6, 0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle = 'rgba(255,255,255,0.95)';
        const fontSize = Math.max(14*dpr, Math.floor(R/8));
        ctx.font = `${fontSize}px sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        // простой перенос длинных строк (разбиваем по пробелам)
        const label = segments[i];
        const words = label.split(' ');
        const lines = [];
        let line = '';
        for (let w of words){
          const test = line ? line + ' ' + w : w;
          if (ctx.measureText(test).width > R*0.6 && line){
            lines.push(line);
            line = w;
          } else {
            line = test;
          }
        }
        if (line) lines.push(line);
        const lh = fontSize * 1.05;
        const offset = -((lines.length-1)/2)*lh;
        for (let k=0;k<lines.length;k++){
          ctx.fillText(lines[k], 0, offset + k*lh);
        }
        ctx.restore();
      }

      ctx.restore();

      // центр
      ctx.beginPath(); ctx.arc(Cx, Cy, 50*dpr, 0, Math.PI*2); ctx.fillStyle = 'rgba(7,18,35,0.9)'; ctx.fill();
      // стрелка указатель — рисуется поверх canvas через DOM (в HTML) — поэтому здесь не нужен
    }

    // корректный расчёт индекса, куда указатель сверху смотрит
    function getSelectedIndex(){
      const n = segments.length;
      const slice = (Math.PI*2)/n;
      // вычисляем относительный угол от начала сегмента (мы рисовали сегменты начиная с -PI/2)
      // после всех сокращений получается: rel = (-rotation mod 2PI)
      let rel = (-rotation) % (Math.PI*2);
      if (rel < 0) rel += Math.PI*2;
      const idx = Math.floor(rel / slice) % n;
      return idx;
    }

    // анимация спина: задаём целевой угол и интерполируем easing'ом
    function spin(){
      if (spinning) return;
      spinning = true;
      const n = segments.length;

      // случайное количество оборотов + целевой сегмент (необязательно заранее определяем результат)
      const extraRotations = 4 + Math.random()*4; // 4..8 оборотов
      const randomOffset = Math.random() * Math.PI*2; // рандомная фаза
      const targetDelta = extraRotations * Math.PI*2 + randomOffset;

      const startRot = rotation;
      const targetRot = startRot + targetDelta;
      const duration = 2500 + Math.random()*2000; // ms
      const startT = performance.now();

      function frame(now){
        const t = Math.min(1, (now - startT)/duration);
        // easeOutCubic
        const eased = 1 - Math.pow(1 - t, 3);
        rotation = startRot + (targetRot - startRot) * eased;
        draw();
        if (t < 1){
          requestAnimationFrame(frame);
        } else {
          spinning = false;
          // корректируем rotation в пределах 0..2PI для стабильности
          rotation = rotation % (Math.PI*2);
          if (rotation < 0) rotation += Math.PI*2;
          const idx = getSelectedIndex();
          flashAndShow(idx);
        }
      }
      requestAnimationFrame(frame);
    }

    function flashAndShow(idx){
      const value = segments[idx];
      let flashes = 6;
      let show = true;
      const iv = setInterval(()=>{
        draw(show ? idx : -1);
        show = !show;
        flashes--;
        if (flashes <= 0){
          clearInterval(iv);
          draw(idx);
          resultEl.innerHTML = `<strong>Выпало:</strong> ${value}`;
          // если это первый спин на валюты, переключаем на числа
          if (!isNumbersMode){
            setTimeout(()=>{
              switchToNumbers();
            }, 700);
          }
        }
      }, 220);
    }

    function switchToNumbers(){
      segments = Array.from({length:50}, (_,i) => String(i+1));
      isNumbersMode = true;
      rotation = 0;
      resultEl.innerHTML += ' <span class="muted">(обновлён на числа 1–50)</span>';
      draw();
    }

    spinBtn.addEventListener('click', spin);
    resetBtn.addEventListener('click', ()=>{
      segments = initialSegments.slice();
      isNumbersMode = false;
      rotation = 0;
      resultEl.textContent = 'Сброшено: возвращены валюты.';
      draw();
    });

    // пробел — тоже спин
    window.addEventListener('keydown', (e)=>{ if (e.code === 'Space') { e.preventDefault(); spin(); } });

    // начальный рендер
    draw();
  </script></body>
</html>
